import java.io.BufferedReader;
import java.io.DataInputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.ServerSocket;
import java.net.Socket;

/**
 * SensorConnThread
 * Process connection request of the sensor manager and open communication channel. (just like that with the client)
 * */
public class SensorConnThread extends Thread
{
	/**
	 * The sensor manager should use the same number.
	 * */
	int mServerPortNum = 9101;
	
	ServerSocket mAcceptSocket = null;
	
	SensorConnThread()
	{
		super();
		
		try{
			// Fixed port number.
			mAcceptSocket = new ServerSocket(mServerPortNum);
			
		}catch (Exception e){
			System.err.println("Exception creating ServerSocket");
		}
	}
	
	public void run() 
	{
		boolean bLoop = true;
		while(bLoop)
		{
			// Continuously waiting for a new sensor manager connection and generate a communication thread for each accepted sensor manager (but actually just one?).
			
			System.out.println("Waiting for sensor manager connection at port " + mServerPortNum);

			try {
				// Will be blocked here..
				Socket SensorSocket = mAcceptSocket.accept();
				
				// Connected and create a new communication channel.
				Thread SensorThreadObj = new SensorCommThread(SensorSocket);
				SensorThreadObj.start();
			
				System.out.println("A sensor manager is connected @ " + SensorSocket.getLocalAddress() + ":" + SensorSocket.getLocalPort());
				
				// We probably need to manage all the connected client list, but not for this semester?
				
			} catch (IOException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}
	}
}


/**
 * SensorCommThread
 * Communication to the sensor manager which contains all sensor's updated information,
 * being the port of getting the raw hardware information
 * */
class SensorCommThread extends Thread 
{
	Socket mCommSocket;
	
	SensorCommThread(Socket InSocket)
	{
		super();
		
		this.mCommSocket = InSocket;
	}

	
	public void run() 
	{
		// Initialize and do some communication to the sensor.
		
		boolean bLoop = true;
		while(bLoop)
		{		
			// Just receive the information
			try {
				
				// For getting the packet in string format.
				BufferedReader SensorDataReader = new BufferedReader(new InputStreamReader(mCommSocket.getInputStream())); 
				String RecvString = SensorDataReader.readLine();
				
				
				boolean bNewState = !DataManager.GetSingleRestroomItemOccupied(ServerMain.EXAMPLE_RESTROOM_FLOORNUM, ServerMain.EXAMPLE_MALE_RESTROOM_ROOMNUM, 1);
					
				// When you get the data from the sensor, set the data by calling DataManager.SetSingleRestroomItemOccupied();
				DataManager.SetSingleRestroomItemOccupied(ServerMain.EXAMPLE_RESTROOM_FLOORNUM, ServerMain.EXAMPLE_MALE_RESTROOM_ROOMNUM, 1, 
						bNewState);
					
				System.out.println("Restroom " + ServerMain.EXAMPLE_RESTROOM_FLOORNUM + " " +  ServerMain.EXAMPLE_MALE_RESTROOM_ROOMNUM
						+ " usage state changed to " + bNewState);	
				
				
				
				
			} catch (IOException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
			
		}
		
	}
}
